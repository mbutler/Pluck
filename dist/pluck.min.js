class p{constructor(){this.events={start:[],stop:[],loop:[],scheduled:[],play:[],effect:[]}}on(e,t){if(this.events[e])this.events[e].push(t);else console.error(`Event ${e} is not supported.`)}off(e,t){if(this.events[e])this.events[e]=this.events[e].filter((i)=>i!==t);else console.error(`Event ${e} is not supported.`)}trigger(e,t,i){if(this.events[e])this.events[e].forEach((r)=>r(t,i))}}var c=p;var s=new WeakMap;class h{constructor(e={}){const t=e.context||new(window.AudioContext||window.webkitAudioContext),i=t.createGain(),r={fileName:e.file||null,context:t,source:null,audioBuffer:e.audioBuffer||null,volume:e.volume||1,loop:e.loop||!1,attack:e.attack||0.04,release:e.release||0.04,offset:e.offset||0,gainNode:i,mediaStream:e.input||null,clearBuffer:e.clearBuffer||!1,isPlaying:!1,isGrouped:!1,events:new c};s.set(this,r),this.initialized=this.initialize(e)}async initialize(e){try{await this.initSource(e)}catch(t){console.error("Error initializing source:",t)}}async initSource(e){if(e.file)await this.loadFromFile(e.file);else if(e.wave)this.initFromWave(e.wave);else if(e.input)await this.initFromInput();else this.initFromWave({type:"sine",frequency:440})}async loadFromFile(e){try{const i=await(await fetch(e)).arrayBuffer();this.audioBuffer=await this.context.decodeAudioData(i),this.createSourceFromBuffer()}catch(t){console.error("Error loading sound file:",t)}}createSourceFromBuffer(){if(!this.audioBuffer){console.error("No audio buffer to create source from");return}this.source=this.context.createBufferSource(),this.source.buffer=this.audioBuffer,this.source.loop=this.loop,this.connectGain(),this.source.onended=()=>{if(this.isPlaying=!1,this.source=null,this.clearBuffer)this.audioBuffer=null}}initFromWave(e){this.source=this.context.createOscillator(),this.source.type=e.type||"sine",this.source.frequency.value=e.frequency||440,this.connectGain(),this.source.onended=()=>{this.isPlaying=!1,this.source=null}}async initFromInput(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});this.mediaStream=e,this.source=this.context.createMediaStreamSource(e),this.connectGain()}catch(e){console.error("Error initializing microphone input:",e)}}connectGain(){if(this.source)this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination);else console.error("No source to connect to gain node")}async play(e=!1){if(this.isGrouped&&!e){console.warn(`Cannot play the sound ${this.fileName} directly. It is in a group.`);return}if(this.isPlaying=!0,await this.initialized,this.context.state==="suspended")await this.context.resume();if(!this.audioBuffer&&!this.source){console.error("No audio buffer or source available to play");return}if(!this.isGrouped&&this.audioBuffer&&!e)this.source=null,this.createSourceFromBuffer();if(this.mediaStream)return;if(this.source&&this.source.start)this.applyAttack(),this.events.trigger("play"),this.source.start(this.context.currentTime,this.offset);else console.error("No source to play"),this.isPlaying=!1}stop(){if(this.isPlaying=!1,this.mediaStream){this.mediaStream.getTracks().forEach((e)=>e.stop()),this.source.disconnect(),this.source=null;return}if(this.source&&this.source.stop)this.applyRelease(()=>{if(this.source.stop(),this.source.disconnect(),this.source=null,this.clearBuffer)this.audioBuffer=null})}clone(){const e=s.get(this);return new h({context:e.context,audioBuffer:e.audioBuffer,volume:e.volume,loop:e.loop,attack:e.attack,release:e.release,input:this.mediaStream||null,clearBuffer:e.clearBuffer,file:this.source&&this.source.buffer?this.source.buffer:void 0,wave:this.source&&this.source.frequency?{type:this.source.type,frequency:this.source.frequency.value}:void 0})}applyAttack(){if(!this.gainNode)return;const e=this.context.currentTime;this.gainNode.gain.setValueAtTime(0,e),this.gainNode.gain.linearRampToValueAtTime(this.volume,e+this.attack)}applyRelease(){if(!this.gainNode)return;const e=this.context.currentTime;this.gainNode.gain.setValueAtTime(this.volume,e),this.gainNode.gain.linearRampToValueAtTime(0,e+this.release)}connect(e){const t=s.get(this);if(t.source)t.source.connect(e);else console.error("No source to connect")}disconnect(e){const t=s.get(this);if(t.source)t.source.disconnect(e);else console.error("No source to disconnect")}get fileName(){return s.get(this).fileName}get context(){return s.get(this).context}get source(){return s.get(this).source}set source(e){const t=s.get(this);t.source=e}get audioBuffer(){return s.get(this).audioBuffer}set audioBuffer(e){const t=s.get(this);t.audioBuffer=e}get volume(){return s.get(this).volume}set volume(e){const t=s.get(this);if(t.volume=e,t.gainNode)t.gainNode.gain.value=e}get loop(){return s.get(this).loop}set loop(e){const t=s.get(this);t.loop=e}get attack(){return s.get(this).attack}set attack(e){const t=s.get(this);t.attack=e}get release(){return s.get(this).release}set release(e){const t=s.get(this);t.release=e}get offset(){return s.get(this).offset}set offset(e){const t=s.get(this);t.offset=e}get gainNode(){return s.get(this).gainNode}get mediaStream(){return s.get(this).mediaStream}set mediaStream(e){const t=s.get(this);t.mediaStream=e}get clearBuffer(){return s.get(this).clearBuffer}set clearBuffer(e){const t=s.get(this);t.clearBuffer=e}get isPlaying(){return s.get(this).isPlaying}set isPlaying(e){const t=s.get(this);t.isPlaying=e}get isGrouped(){return s.get(this).isGrouped}set isGrouped(e){const t=s.get(this);t.isGrouped=e}get events(){return s.get(this).events}set events(e){const t=s.get(this);t.events=e}}var a=h;class g{constructor(){this.queue=[]}enqueue(e,t){const i={item:e,priority:t};this.queue.push(i),this.bubbleUp(this.queue.length-1)}dequeue(){if(this.isEmpty())return null;const e=this.queue[0],t=this.queue.pop();if(this.queue.length>0)this.queue[0]=t,this.bubbleDown(0);return e.item}peek(){return this.queue[0]}isEmpty(){return this.queue.length===0}bubbleUp(e){const t=this.queue[e];while(e>0){const i=Math.floor((e-1)/2),r=this.queue[i];if(t.priority>=r.priority)break;this.queue[e]=r,e=i}this.queue[e]=t}bubbleDown(e){const t=this.queue.length,i=this.queue[e];while(!0){const r=2*e+1,l=2*e+2;let f=this.queue[r],d=this.queue[l],u=null;if(r<t){if(f.priority<i.priority)u=r}if(l<t){if(u===null&&d.priority<i.priority||u!==null&&d.priority<f?.priority)u=l}if(u===null)break;this.queue[e]=this.queue[u],e=u}this.queue[e]=i}remove(e){const t=this.queue.findIndex((r)=>r.item===e);if(t===-1)return!1;const i=this.queue.pop();if(t<this.queue.length)this.queue[t]=i,this.bubbleUp(t),this.bubbleDown(t);return!0}}var m=g;var o=new WeakMap;class y{constructor(){const e={context:null,currentTime:0,isPlaying:!1,soundQueue:new m,intervalIDs:{},events:new c};o.set(this,e)}startInterval(e,t){const i=setInterval(()=>{t()},e*1000);this.intervalIDs={...this.intervalIDs,[e]:i}}stopInterval(e){const t=this.intervalIDs[e];if(t){clearInterval(t);const{[e]:i,...r}=this.intervalIDs;this.intervalIDs=r}}async start(){console.info("Starting timeline"),this.context=new(window.AudioContext||window.webkitAudioContext),this.isPlaying=!0,this.events.trigger("start"),await this.context.resume(),this.loop()}async loop(){if(!this.isPlaying)return;this.currentTime=this.context.currentTime;while(!this.soundQueue.isEmpty()&&this.soundQueue.peek().priority<=this.currentTime){const e=this.soundQueue.dequeue(),{sound:t,time:i}=e;if(t)try{await t.play(),this.events.trigger("play",t,this.currentTime)}catch(r){console.error("Error playing sound:",r)}}this.events.trigger("loop"),requestAnimationFrame(()=>this.loop())}stop(){Object.keys(this.intervalIDs).forEach((e)=>{this.stopInterval(Number(e))});while(!this.soundQueue.isEmpty()){const e=this.soundQueue.dequeue(),{sound:t}=e;if(t&&t.isPlaying)t.stop()}if(this.context&&this.context.state!=="closed")this.context.close();this.isPlaying=!1,this.events.trigger("stop")}scheduleSound(e,t){this.soundQueue.enqueue({sound:e,time:t},t),this.events.trigger("scheduled",e,t)}rescheduleSound(e,t){this.soundQueue.remove(e),this.scheduleSound(e,t)}playNow(e){this.soundQueue.enqueue({sound:e,time:this.currentTime},this.currentTime)}async addSound(e,t,i={}){const r=new a({file:e,...i});await r.initialized,this.scheduleSound(r,t)}async playSound(e,t={}){const i=new a({file:e,...t});await i.initialized,await i.play(),this.events.trigger("play",i,this.currentTime)}future(e){return this.currentTime+e}runEverySecond(){console.info("Every second")}get context(){return o.get(this).context}set context(e){const t=o.get(this);t.context=e}get currentTime(){return o.get(this).currentTime}set currentTime(e){const t=o.get(this);t.currentTime=e}get isPlaying(){return o.get(this).isPlaying}set isPlaying(e){const t=o.get(this);t.isPlaying=e}get soundQueue(){return o.get(this).soundQueue}get intervalIDs(){return o.get(this).intervalIDs}set intervalIDs(e){const t=o.get(this);t.intervalIDs=e}get events(){return o.get(this).events}set events(e){const t=o.get(this);t.events=e}}var v=y;var n=new WeakMap;class w{constructor(e){if(!e instanceof AudioContext){console.error("No audio context provided to Group");return}const t=e.createGain();t.connect(e.destination);const i={context:e,gainNode:t,sounds:[],volume:1,muted:!1,previousVolume:1};n.set(this,i)}async play(){const e=this.sounds.map(async(t)=>{if(!t.isPlaying)try{await t.play(!0)}catch(i){console.error("Error playing sound:",i)}});await Promise.all(e)}async stop(){const e=this.sounds.map(async(t)=>{if(t.isPlaying)t.stop()});await Promise.all(e)}addSounds(e){if(!Array.isArray(e)){console.error("Not an array of sounds");return}e.forEach((t)=>{if(!(t instanceof a)){console.error("The sound is not an instance of Sound class:",t);return}if(t.context!==this.context){console.error("Cannot add sound to group: mismatched audio contexts",t);return}t.isGrouped=!0,t.disconnect(t.gainNode),this.sounds.push(t),t.connect(this.gainNode)})}removeSound(e){const t=this.sounds.indexOf(e);if(t===-1){console.warn("The sound is not in the group");return}if(e.disconnect(this.gainNode),this.sounds.splice(t,1),this.sounds.length===0)this.gainNode.disconnect(this.context.destination)}fadeVolumeTo(e,t=1){const i=this.context.currentTime;gainNode.gain.setValueAtTime(gainNode.gain.value,i),gainNode.gain.linearRampToValueAtTime(e,i+t),console.log(`Volume set to ${e} over ${t} seconds`)}mute(){if(!this.muted)this.previousVolume=this.volume,this.volume=0,this.muted=!0}unmute(){if(this.muted)this.volume=this.previousVolume,this.muted=!1}get context(){return n.get(this).context}get gainNode(){return n.get(this).gainNode}get sounds(){return n.get(this).sounds}get volume(){return n.get(this).gainNode.gain.value}set volume(e){n.get(this).gainNode.gain.value=e}get muted(){return n.get(this).muted}set muted(e){n.get(this).muted=e}get previousVolume(){return n.get(this).previousVolume}set previousVolume(e){n.get(this).previousVolume=e}}var x=w;window.Pluck={Timeline:v,Sound:a,Group:x};
